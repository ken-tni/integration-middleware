2025-05-18 17:27:58 | ERROR    | app.adapters.erp_next.adapter:search:136 - Error searching for quotation: isinstance() arg 2 must be a type, a tuple of types, or a union
2025-05-18 17:27:58 | ERROR    | app.api.v1.endpoints.quotations:list_quotations:68 - Error listing quotations: Failed to search for quotation (System: ERPNext)
2025-05-18 17:27:58 | ERROR    | app.utils.exception_handlers:unhandled_exception_handler:111 - Unhandled exception: 'NoneType' object has no attribute 'HTTP_502_BAD_GATEWAY'
Traceback (most recent call last):

  File "E:\Work\Shahab\Dev\ERPNext Copilot\integration-middleware\app\adapters\erp_next\adapter.py", line 115, in search
    count_response = await self.client.get(
                           │    │      └ <function ERPNextClient.get at 0x000002048B9F53A0>
                           │    └ <app.adapters.erp_next.client.ERPNextClient object at 0x000002048BDA41D0>
                           └ <app.adapters.erp_next.adapter.ERPNextAdapter object at 0x000002048BD0EDE0>

  File "E:\Work\Shahab\Dev\ERPNext Copilot\integration-middleware\app\adapters\erp_next\client.py", line 150, in get
    return await self._request("GET", path, params=params)
                 │    │               │            └ {'filters': []}
                 │    │               └ '/api/resource/Quotation/count'
                 │    └ <function ERPNextClient._request at 0x000002048B9F5300>
                 └ <app.adapters.erp_next.client.ERPNextClient object at 0x000002048BDA41D0>

  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\tenacity\asyncio\__init__.py", line 189, in async_wrapped
    return await copy(fn, *args, **kwargs)
                 │    │    │       └ {'params': {'filters': []}}
                 │    │    └ (<app.adapters.erp_next.client.ERPNextClient object at 0x000002048BDA41D0>, 'GET', '/api/resource/Quotation/count')
                 │    └ <function ERPNextClient._request at 0x000002048B9F5080>
                 └ <AsyncRetrying object at 0x2048bd66f60 (stop=<tenacity.stop.stop_after_attempt object at 0x000002048B9AC770>, wait=<tenacity....
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\tenacity\asyncio\__init__.py", line 111, in __call__
    do = await self.iter(retry_state=retry_state)
               │    │                └ <RetryCallState 2218549211120: attempt #1; slept for 0.0; last result: failed (EntityNotFoundError Count with ID '' not found...
               │    └ <function AsyncRetrying.iter at 0x000002048B9F4CC0>
               └ <AsyncRetrying object at 0x2048bd66f60 (stop=<tenacity.stop.stop_after_attempt object at 0x000002048B9AC770>, wait=<tenacity....
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\tenacity\asyncio\__init__.py", line 153, in iter
    result = await action(retry_state)
                   │      └ <RetryCallState 2218549211120: attempt #1; slept for 0.0; last result: failed (EntityNotFoundError Count with ID '' not found...
                   └ <bound method AsyncRetrying._run_retry of <AsyncRetrying object at 0x2048bd66f60 (stop=<tenacity.stop.stop_after_attempt obje...
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\tenacity\asyncio\__init__.py", line 129, in _run_retry
    self.iter_state.retry_run_result = await _utils.wrap_to_async_func(self.retry)(
    │    │                                   │      │                  │    └ <tenacity.retry.retry_if_exception_type object at 0x000002048B9E5E80>
    │    │                                   │      │                  └ <AsyncRetrying object at 0x2048bd66f60 (stop=<tenacity.stop.stop_after_attempt object at 0x000002048B9AC770>, wait=<tenacity....
    │    │                                   │      └ <function wrap_to_async_func at 0x000002048B9A68E0>
    │    │                                   └ <module 'tenacity._utils' from 'C:\\Users\\pouri\\AppData\\Roaming\\Python\\Python312\\site-packages\\tenacity\\_utils.py'>
    │    └ <property object at 0x000002048B9EA200>
    └ <AsyncRetrying object at 0x2048bd66f60 (stop=<tenacity.stop.stop_after_attempt object at 0x000002048B9AC770>, wait=<tenacity....
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\tenacity\_utils.py", line 99, in inner
    return call(*args, **kwargs)
           │     │       └ {}
           │     └ (<RetryCallState 2218549211120: attempt #1; slept for 0.0; last result: failed (EntityNotFoundError Count with ID '' not foun...
           └ <tenacity.retry.retry_if_exception_type object at 0x000002048B9E5E80>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\tenacity\retry.py", line 82, in __call__
    return self.predicate(exception)
           │    │         └ EntityNotFoundError("Count with ID '' not found (System: ERPNext)")
           │    └ <function retry_if_exception_type.__init__.<locals>.<lambda> at 0x000002048B9DFD80>
           └ <tenacity.retry.retry_if_exception_type object at 0x000002048B9E5E80>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\tenacity\retry.py", line 98, in <lambda>
    super().__init__(lambda e: isinstance(e, exception_types))
                            │             │  └ <function create_retry_decorator.<locals>.should_retry at 0x000002048B9DFB00>
                            │             └ EntityNotFoundError("Count with ID '' not found (System: ERPNext)")
                            └ EntityNotFoundError("Count with ID '' not found (System: ERPNext)")

TypeError: isinstance() arg 2 must be a type, a tuple of types, or a union


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "E:\Work\Shahab\Dev\ERPNext Copilot\integration-middleware\app\api\v1\endpoints\quotations.py", line 65, in list_quotations
    result = await adapter.search("quotation", filters, page, page_size)
                   │       │                   │        │     └ 100
                   │       │                   │        └ 1
                   │       │                   └ {}
                   │       └ <function ERPNextAdapter.search at 0x000002048BA9A660>
                   └ <app.adapters.erp_next.adapter.ERPNextAdapter object at 0x000002048BD0EDE0>

  File "E:\Work\Shahab\Dev\ERPNext Copilot\integration-middleware\app\adapters\erp_next\adapter.py", line 137, in search
    raise AdapterError(
          └ <class 'app.core.exceptions.AdapterError'>

app.core.exceptions.AdapterError: Failed to search for quotation (System: ERPNext)


During handling of the above exception, another exception occurred:


Traceback (most recent call last):

  File "E:\Work\Shahab\Dev\ERPNext Copilot\integration-middleware\main.py", line 32, in <module>
    uvicorn.run(
    │       └ <function run at 0x0000020489A71A80>
    └ <module 'uvicorn' from 'C:\\Users\\pouri\\AppData\\Roaming\\Python\\Python312\\site-packages\\uvicorn\\__init__.py'>

  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\uvicorn\main.py", line 587, in run
    server.run()
    │      └ <function Server.run at 0x0000020489ABD1C0>
    └ <uvicorn.server.Server object at 0x000002048BC18740>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\uvicorn\server.py", line 61, in run
    return asyncio.run(self.serve(sockets=sockets))
           │       │   │    │             └ None
           │       │   │    └ <function Server.serve at 0x0000020489ABD260>
           │       │   └ <uvicorn.server.Server object at 0x000002048BC18740>
           │       └ <function run at 0x0000020488E66160>
           └ <module 'asyncio' from 'C:\\Python312\\Lib\\asyncio\\__init__.py'>
  File "C:\Python312\Lib\asyncio\runners.py", line 194, in run
    return runner.run(main)
           │      │   └ <coroutine object Server.serve at 0x00000204899A5940>
           │      └ <function Runner.run at 0x0000020488FB5440>
           └ <asyncio.runners.Runner object at 0x0000020486DD47D0>
  File "C:\Python312\Lib\asyncio\runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           │    │     │                  └ <Task pending name='Task-1' coro=<Server.serve() running at C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\uvi...
           │    │     └ <function BaseEventLoop.run_until_complete at 0x0000020488FBB060>
           │    └ <ProactorEventLoop running=True closed=False debug=False>
           └ <asyncio.runners.Runner object at 0x0000020486DD47D0>
  File "C:\Python312\Lib\asyncio\base_events.py", line 674, in run_until_complete
    self.run_forever()
    │    └ <function ProactorEventLoop.run_forever at 0x00000204890D6FC0>
    └ <ProactorEventLoop running=True closed=False debug=False>
  File "C:\Python312\Lib\asyncio\windows_events.py", line 322, in run_forever
    super().run_forever()
  File "C:\Python312\Lib\asyncio\base_events.py", line 641, in run_forever
    self._run_once()
    │    └ <function BaseEventLoop._run_once at 0x0000020488FB4E00>
    └ <ProactorEventLoop running=True closed=False debug=False>
  File "C:\Python312\Lib\asyncio\base_events.py", line 1986, in _run_once
    handle._run()
    │      └ <function Handle._run at 0x0000020488E66FC0>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x000002048BDF14E0>()>
  File "C:\Python312\Lib\asyncio\events.py", line 88, in _run
    self._context.run(self._callback, *self._args)
    │    │            │    │           │    └ <member '_args' of 'Handle' objects>
    │    │            │    │           └ <Handle <_asyncio.TaskStepMethWrapper object at 0x000002048BDF14E0>()>
    │    │            │    └ <member '_callback' of 'Handle' objects>
    │    │            └ <Handle <_asyncio.TaskStepMethWrapper object at 0x000002048BDF14E0>()>
    │    └ <member '_context' of 'Handle' objects>
    └ <Handle <_asyncio.TaskStepMethWrapper object at 0x000002048BDF14E0>()>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\uvicorn\protocols\http\httptools_impl.py", line 426, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
                   └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x000002048BCBA0C0>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\uvicorn\middleware\proxy_headers.py", line 84, in __call__
    return await self.app(scope, receive, send)
                 │    │   │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x000002048B...
                 │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x0000020...
                 │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.3'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
                 │    └ <fastapi.applications.FastAPI object at 0x000002048BD0D130>
                 └ <uvicorn.middleware.proxy_headers.ProxyHeadersMiddleware object at 0x000002048BCBA0C0>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\fastapi\applications.py", line 1115, in __call__
    await super().__call__(scope, receive, send)
                           │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x000002048B...
                           │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x0000020...
                           └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.3'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\starlette\applications.py", line 122, in __call__
    await self.middleware_stack(scope, receive, send)
          │    │                │      │        └ <bound method RequestResponseCycle.send of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x000002048B...
          │    │                │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x0000020...
          │    │                └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.3'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x000002048BD66CC0>
          └ <fastapi.applications.FastAPI object at 0x000002048BD0D130>
> File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\starlette\middleware\errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
          │    │   │      │        └ <function ServerErrorMiddleware.__call__.<locals>._send at 0x000002048BB6E0C0>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x0000020...
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.3'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x000002048BD66C90>
          └ <starlette.middleware.errors.ServerErrorMiddleware object at 0x000002048BD66CC0>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\starlette\middleware\exceptions.py", line 79, in __call__
    raise exc
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\starlette\middleware\exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
          │    │   │      │        └ <function ExceptionMiddleware.__call__.<locals>.sender at 0x000002048BD51E40>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x0000020...
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.3'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <fastapi.middleware.asyncexitstack.AsyncExitStackMiddleware object at 0x000002048BD66BD0>
          └ <starlette.middleware.exceptions.ExceptionMiddleware object at 0x000002048BD66C90>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\fastapi\middleware\asyncexitstack.py", line 20, in __call__
    raise e
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\fastapi\middleware\asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
          │    │   │      │        └ <function ExceptionMiddleware.__call__.<locals>.sender at 0x000002048BD51E40>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x0000020...
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.3'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <fastapi.routing.APIRouter object at 0x000002048BD0D220>
          └ <fastapi.middleware.asyncexitstack.AsyncExitStackMiddleware object at 0x000002048BD66BD0>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\starlette\routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
          │     │      │      │        └ <function ExceptionMiddleware.__call__.<locals>.sender at 0x000002048BD51E40>
          │     │      │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x0000020...
          │     │      └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.3'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │     └ <function Route.handle at 0x000002048B342D40>
          └ APIRoute(path='/api/v1/quotations', name='list_quotations', methods=['GET'])
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\starlette\routing.py", line 276, in handle
    await self.app(scope, receive, send)
          │    │   │      │        └ <function ExceptionMiddleware.__call__.<locals>.sender at 0x000002048BD51E40>
          │    │   │      └ <bound method RequestResponseCycle.receive of <uvicorn.protocols.http.httptools_impl.RequestResponseCycle object at 0x0000020...
          │    │   └ {'type': 'http', 'asgi': {'version': '3.0', 'spec_version': '2.3'}, 'http_version': '1.1', 'server': ('127.0.0.1', 8000), 'cl...
          │    └ <function request_response.<locals>.app at 0x000002048BD52660>
          └ APIRoute(path='/api/v1/quotations', name='list_quotations', methods=['GET'])
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\starlette\routing.py", line 66, in app
    response = await func(request)
                     │    └ <starlette.requests.Request object at 0x000002048BD0DA00>
                     └ <function get_request_handler.<locals>.app at 0x000002048BD525C0>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\fastapi\routing.py", line 274, in app
    raw_response = await run_endpoint_function(
                         └ <function run_endpoint_function at 0x000002048B343E20>
  File "C:\Users\pouri\AppData\Roaming\Python\Python312\site-packages\fastapi\routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
                 │         │      └ {'page': 1, 'page_size': 100, 'customer_name': None, 'status': None, 'from_date': None, 'to_date': None, 'adapter_name': 'erp...
                 │         └ <function list_quotations at 0x000002048BAEA7A0>
                 └ <fastapi.dependencies.models.Dependant object at 0x000002048BD365A0>

  File "E:\Work\Shahab\Dev\ERPNext Copilot\integration-middleware\app\api\v1\endpoints\quotations.py", line 69, in list_quotations
    raise HTTPException(status_code=status.HTTP_502_BAD_GATEWAY, detail=str(e))
          │                         └ None
          └ <class 'fastapi.exceptions.HTTPException'>

AttributeError: 'NoneType' object has no attribute 'HTTP_502_BAD_GATEWAY'
2025-05-18 17:41:48 | ERROR    | app.adapters.erp_next.adapter:search:136 - Error searching for quotation: isinstance() arg 2 must be a type, a tuple of types, or a union
2025-05-18 17:41:48 | ERROR    | app.api.v1.endpoints.quotations:list_quotations:68 - Error listing quotations: Failed to search for quotation (System: ERPNext)
2025-05-18 17:54:01 | ERROR    | app.adapters.erp_next.adapter:search:136 - Error searching for quotation: isinstance() arg 2 must be a type, a tuple of types, or a union
2025-05-18 17:54:01 | ERROR    | app.api.v1.endpoints.quotations:list_quotations:68 - Error listing quotations: Failed to search for quotation (System: ERPNext)
2025-05-18 17:54:44 | ERROR    | app.adapters.erp_next.adapter:search:136 - Error searching for quotation: 3 validation errors for Quotation
created_at
  Field required [type=missing, input_value={'id': 'SAL-QTN-2024-0000... 'SAL-QTN-2024-00005'})}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.4/v/missing
updated_at
  Field required [type=missing, input_value={'id': 'SAL-QTN-2024-0000... 'SAL-QTN-2024-00005'})}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.4/v/missing
transaction_date
  Input should be a valid date [type=date_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.4/v/date_type
2025-05-18 17:54:44 | ERROR    | app.api.v1.endpoints.quotations:list_quotations:68 - Error listing quotations: Failed to search for quotation (System: ERPNext)
